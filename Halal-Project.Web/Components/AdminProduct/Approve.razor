@page "/admin/approve-request/{RequestId:guid}"
@rendermode InteractiveServer
@inject HttpClient HttpClient
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject ProtectedLocalStorage LocalStorage
@inject ILogger<Approve> Logger
@using System.Text.Json
@using Authentication
@using Microsoft.AspNetCore.Components.Authorization
@using HalalProject.Model.Models
@using System.IdentityModel.Tokens.Jwt
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations

<div class="flex min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
    <AdminSidebar />
    <div class="flex-1 overflow-y-auto p-6 md:p-10">
        @if (!string.IsNullOrEmpty(notificationMessage))
        {
            <div class="mb-6 rounded-lg p-4 shadow-lg @(isSuccess ? "bg-green-50 text-green-800 border border-green-200" : "bg-red-50 text-red-800 border border-red-200") transition-all duration-300">
                @notificationMessage
                <button type="button" @onclick="ClearNotification" class="ml-4 text-sm font-semibold hover:underline focus:outline-none">Close</button>
            </div>
        }
        <div class="rounded-2xl bg-white p-6 md:p-8 shadow-xl border border-gray-100">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-blue-900 tracking-tight">Product Approval</h2>
                <button type="button" @onclick="Cancel" class="rounded-lg bg-blue-600 text-white px-5 py-2.5 hover:bg-blue-700 transition-colors duration-200 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    Back to Requests
                </button>
            </div>

            @if (isLoading)
            {
                <div class="flex justify-center items-center h-64">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-600"></div>
                </div>
            }
            else if (productRequest != null)
            {
 

                <EditForm Model="@productRequest" OnValidSubmit="ApproveProduct" class="space-y-6">
                    <DataAnnotationsValidator />
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Left Column: Image -->
                        <div class="lg:col-span-1">
                            <div class="relative rounded-xl overflow-hidden shadow-md bg-gray-100 flex items-center justify-center">
                                @if (!string.IsNullOrEmpty(normalizedImageUrl))
                                {
                                    <img src="@normalizedImageUrl" alt="@productRequest.ProductName" class="h-56 w-56 object-contain" loading="lazy" @onerror="HandleImageError" />
                                }
                                else
                                {
                                    <div class="h-56 w-56 flex items-center justify-center bg-gray-200">
                                        <svg class="h-10 w-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                }
                            </div>
                            <div class="mt-4">
                                <label for="image" class="block text-sm font-medium text-blue-900">Upload New Image</label>
                                <InputFile id="image" OnChange="OnImageChange" class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-700" />
                                @if (!string.IsNullOrEmpty(imageError))
                                {
                                    <p class="mt-1 text-sm text-red-500">@imageError</p>
                                }
                            </div>
                        </div>

                        <!-- Right Column: Product Info and Ingredients -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Product Info -->
                            <div class="bg-gray-50 p-6 rounded-xl shadow-sm">
                                <h3 class="text-xl font-semibold text-blue-900 mb-4">Product Information</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-blue-900">Product Name *</label>
                                        <InputText @bind-Value="productRequest.ProductName" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700" />
                                        <ValidationMessage For="@(() => productRequest.ProductName)" class="text-red-500 text-sm mt-1" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-blue-900">Category *</label>
                                        <InputText @bind-Value="productRequest.Category" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700" />
                                        <ValidationMessage For="@(() => productRequest.Category)" class="text-red-500 text-sm mt-1" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-blue-900">Country *</label>
                                        <InputText @bind-Value="productRequest.Country" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700" />
                                        <ValidationMessage For="@(() => productRequest.Country)" class="text-red-500 text-sm mt-1" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-blue-900">Barcode</label>
                                        <InputText @bind-Value="productRequest.Barcode" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-blue-900">Requested By</label>
                                        <input type="text" value="@productRequest.RequestedBy" readonly class="w-full mt-1 p-2 border border-gray-300 rounded-lg bg-gray-100" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-blue-900">Request Date</label>
                                        <input type="text" value="@productRequest.RequestDate.ToString("MMM dd, yyyy")" readonly class="w-full mt-1 p-2 border border-gray-300 rounded-lg bg-gray-100" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-blue-900">Request Type</label>
                                        <input type="text" value="@productRequest.RequestType" readonly class="w-full mt-1 p-2 border border-gray-300 rounded-lg bg-gray-100" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-blue-900">Request Status</label>
                                        <input type="text" value="@productRequest.RequestStatus" readonly class="w-full mt-1 p-2 border border-gray-300 rounded-lg bg-gray-100" />
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-blue-900">Description *</label>
                                    <InputTextArea @bind-Value="productRequest.Description" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700" rows="4" />
                                    <ValidationMessage For="@(() => productRequest.Description)" class="text-red-500 text-sm mt-1" />
                                </div>
                            </div>

                            <!-- Ingredients -->
                            <div class="bg-gray-50 p-6 rounded-xl shadow-sm">
                                <h3 class="text-xl font-semibold text-blue-900 mb-4">Ingredients</h3>
                                <div class="flex items-center space-x-4 mb-4">
                                    <label for="useAI" class="text-sm font-medium text-blue-900">Fetch Ingredients with AI</label>
                                    <input type="checkbox" id="useAI" @bind="useAI" class="h-4 w-4 text-blue-700 focus:ring-blue-500 border-gray-300 rounded" />
                                    @if (useAI)
                                    {
                                        <button type="button" @onclick="FetchIngredients" disabled="@isFetchingAI" class="rounded-lg bg-blue-700 px-4 py-2 text-white hover:bg-blue-800 disabled:opacity-70 disabled:cursor-not-allowed">
                                            @if (isFetchingAI)
                                            {
                                                <span>Fetching...</span>
                                            }
                                            else
                                            {
                                                <span>Fetch Ingredients</span>
                                            }
                                        </button>
                                    }
                                    <button type="button" @onclick="EvaluateIngredients" disabled="@isEvaluating" class="rounded-lg bg-blue-700 px-4 py-2 text-white hover:bg-blue-800 disabled:opacity-70 disabled:cursor-not-allowed">
                                        @if (isEvaluating)
                                        {
                                            <span>Evaluating...</span>
                                        }
                                        else
                                        {
                                            <span>Evaluate Status</span>
                                        }
                                    </button>
                                </div>
                                <div>
                                    <InputTextArea @bind-Value="ingredientsInput" @oninput="OnIngredientsInputChange" class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-700" rows="4" placeholder="Enter ingredients, one per line" />
                                </div>
                                @if (ingredients.Any())
                                {
                                    <div class="grid gap-2 mt-4">
                                        @foreach (var ingredient in ingredients)
                                        {
                                            <div class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200">
                                                <div>
                                                    <input type="text" @bind="ingredient.Name" @bind:event="oninput" @onchange="() => UpdateIngredient(ingredient)" class="p-1 border border-gray-300 rounded w-64" />
                                                    @if (!string.IsNullOrEmpty(ingredient.ECode) && ingredient.ECode != "N/A")
                                                    {
                                                        <span class="text-sm text-gray-500 ml-2">(@ingredient.ECode)</span>
                                                    }
                                                    @if (!string.IsNullOrEmpty(ingredient.Description))
                                                    {
                                                        <p class="text-sm text-gray-600 mt-1">@ingredient.Description</p>
                                                    }
                                                </div>
                                                <div class="flex items-center space-x-4">
                                                    <select @bind:get="ingredient.Status" @bind:set="(value) => ChangeIngredientStatus(ingredient, value)" class="p-1 border border-gray-300 rounded text-sm">
                                                        <option value="Unknown">Unknown</option>
                                                        <option value="Halal">Halal</option>
                                                        <option value="Haram">Haram</option>
                                                        <option value="Mushbooh">Mushbooh</option>
                                                    </select>
                                                    <button type="button" @onclick="() => RemoveIngredient(ingredient)" class="text-red-600 hover:text-red-800 text-sm">Remove</button>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <p class="text-gray-500 mt-4 italic">No ingredients listed. Enter manually or fetch using AI.</p>
                                }
                            </div>

                            <!-- Product Status -->
                            <div class="bg-gray-50 p-6 rounded-xl shadow-sm">
                                <h3 class="text-xl font-semibold text-blue-900 mb-4">Product Status</h3>
                                <p class="text-lg font-semibold @(productStatus == "Halal" ? "text-green-600" : productStatus == "Haram" ? "text-red-600" : productStatus == "Mushbooh" ? "text-yellow-600" : "text-gray-600")">
                                    @(string.IsNullOrEmpty(productStatus) ? "Not evaluated" : productStatus)
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-4 mt-8">
                        <button type="submit" disabled="@isSubmitting" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-70 disabled:cursor-not-allowed">
                            @if (isSubmitting)
                            {
                                <span>Approving...</span>
                            }
                            else
                            {
                                <span>Approve Product</span>
                            }
                        </button>
                        <button type="button" @onclick="RejectProduct" disabled="@isSubmitting" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-70 disabled:cursor-not-allowed">
                            @if (isSubmitting)
                            {
                                <span>Rejecting...</span>
                            }
                            else
                            {
                                <span>Reject Product</span>
                            }
                        </button>
                        <button type="button" @onclick="Cancel" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Cancel</button>
                    </div>
                </EditForm>
            }
            else
            {
                <div class="text-center py-16 bg-gray-50 rounded-xl">
                    <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h3 class="mt-4 text-lg font-medium text-gray-900">Request Not Found</h3>
                    <p class="mt-2 text-sm text-gray-500">The requested product could not be found.</p>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public Guid RequestId { get; set; }

    private ProductChangeRequestDto? productRequest;
    private List<IngredientDto> ingredients = new();
    private string ingredientsInput = string.Empty;
    private string productStatus = string.Empty;
    private bool isLoading = true;
    private string notificationMessage = string.Empty;
    private bool isSuccess = false;
    private bool isAuthenticated = false;
    private bool useAI = false;
    private bool isFetchingAI = false;
    private bool isEvaluating = false;
    private bool isSubmitting = false;
    private string? normalizedImageUrl;
    private string? imageError;
    private IBrowserFile? selectedImage;
    private const string BackendBaseUrl = "https://localhost:7507";

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("Initializing ApproveRequest component for RequestId: {RequestId}", RequestId);
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        isAuthenticated = authState.User.Identity?.IsAuthenticated == true;

        if (!isAuthenticated)
        {
            Logger.LogWarning("Unauthenticated access attempt to approve request page.");
            Navigation.NavigateTo("/login");
            return;
        }

        if (!authState.User.IsInRole("Admin"))
        {
            Logger.LogWarning("Non-admin user attempted to access approve request page.");
            notificationMessage = "Access denied. Admin privileges required.";
            isSuccess = false;
            Navigation.NavigateTo("/unauthorized");
            return;
        }

        Logger.LogInformation("User authenticated as {UserName} with Admin role.", authState.User.Identity?.Name);
        await ConfigureHttpClient();
        await LoadRequestDetails();
        isLoading = false;
    }

    private async Task ConfigureHttpClient()
    {
        try
        {
            Logger.LogInformation("Configuring HttpClient with authorization header.");
            var sessionResult = await LocalStorage.GetAsync<LoginResponseModel>("sessionState");
            if (!sessionResult.Success || sessionResult.Value == null || string.IsNullOrEmpty(sessionResult.Value.Token))
            {
                Logger.LogWarning("No session state or token found in ProtectedLocalStorage.");
                notificationMessage = "Authentication token missing. Please log in again.";
                isSuccess = false;
                await ((CustomAuthStateProvider)AuthStateProvider).MarkUserAsLoggedOut();
                Navigation.NavigateTo("/login");
                return;
            }

            var handler = new JwtSecurityTokenHandler();
            if (!handler.CanReadToken(sessionResult.Value.Token))
            {
                Logger.LogWarning("Invalid JWT token format.");
                notificationMessage = "Invalid authentication token. Please log in again.";
                isSuccess = false;
                await ((CustomAuthStateProvider)AuthStateProvider).MarkUserAsLoggedOut();
                Navigation.NavigateTo("/login");
                return;
            }

            var jwtToken = handler.ReadJwtToken(sessionResult.Value.Token);
            var roleClaim = jwtToken.Claims.FirstOrDefault(c => c.Type == "role" || c.Type == ClaimTypes.Role)?.Value;
            var expClaim = jwtToken.Claims.FirstOrDefault(c => c.Type == "exp")?.Value;

            if (string.IsNullOrEmpty(roleClaim) || roleClaim != "Admin")
            {
                Logger.LogWarning("Token lacks Admin role claim: {Role}", roleClaim);
                notificationMessage = "Access denied. Admin role required.";
                isSuccess = false;
                await ((CustomAuthStateProvider)AuthStateProvider).MarkUserAsLoggedOut();
                Navigation.NavigateTo("/login");
                return;
            }

            if (long.TryParse(expClaim, out var expUnix))
            {
                var expiration = DateTimeOffset.FromUnixTimeSeconds(expUnix);
                if (expiration < DateTimeOffset.UtcNow.AddMinutes(5))
                {
                    Logger.LogWarning("Token is expired or near expiry.");
                    notificationMessage = "Session expired. Please log in again.";
                    isSuccess = false;
                    await ((CustomAuthStateProvider)AuthStateProvider).MarkUserAsLoggedOut();
                    Navigation.NavigateTo("/login");
                    return;
                }
            }

            HttpClient.DefaultRequestHeaders.Remove("Authorization");
            HttpClient.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", sessionResult.Value.Token);
            Logger.LogInformation("Authorization header set successfully.");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error configuring HttpClient with authorization header.");
            notificationMessage = "Failed to configure authentication. Please log in again.";
            isSuccess = false;
            await ((CustomAuthStateProvider)AuthStateProvider).MarkUserAsLoggedOut();
            Navigation.NavigateTo("/login");
        }
    }

    private async Task LoadRequestDetails()
    {
        try
        {
            Logger.LogInformation("Fetching request details for RequestId: {RequestId}", RequestId);
            var response = await HttpClient.GetAsync($"{BackendBaseUrl}/api/ProductChangeRequest/details/{RequestId}");
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<BaseResponseModel>();
                if (result?.Success == true && result.Data != null)
                {
                    productRequest = DeserializeRequest((JsonElement)result.Data);
                    if (productRequest != null)
                    {
                        normalizedImageUrl = NormalizeImageUrl(productRequest.ImageUrl);
                        if (productRequest.Ingredients?.Any() == true)
                        {
                            ingredientsInput = string.Join("\n", productRequest.Ingredients);
                            UpdateIngredientsFromInput();
                        }
                    }
                    else
                    {
                        notificationMessage = "Failed to parse request details.";
                        isSuccess = false;
                    }
                }
                else
                {
                    notificationMessage = "Failed to load request details.";
                    isSuccess = false;
                }
            }
            else
            {
                notificationMessage = $"Failed to load request: {response.StatusCode}";
                isSuccess = false;
                if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
                {
                    await ((CustomAuthStateProvider)AuthStateProvider).MarkUserAsLoggedOut();
                    Navigation.NavigateTo("/login");
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading request details.");
            notificationMessage = $"Error loading request: {ex.Message}";
            isSuccess = false;
        }
        StateHasChanged();
    }

    private async Task OnImageChange(InputFileChangeEventArgs e)
    {
        try
        {
            Logger.LogInformation("OnImageChange: File selected: Name={Name}, Size={Size}, ContentType={ContentType}", e.File?.Name, e.File?.Size ?? 0, e.File?.ContentType);
            selectedImage = e.File;
            imageError = string.Empty;

            var allowedTypes = new[] { "image/jpeg", "image/png", "image/jpg" };
            const long maxSize = 5 * 1024 * 1024; // 5MB

            if (selectedImage == null)
            {
                Logger.LogWarning("OnImageChange: No file selected");
                imageError = "Please select an image file.";
                normalizedImageUrl = NormalizeImageUrl(productRequest?.ImageUrl);
                StateHasChanged();
                return;
            }

            if (!allowedTypes.Contains(selectedImage.ContentType))
            {
                Logger.LogWarning("OnImageChange: Invalid file type: {ContentType}", selectedImage.ContentType);
                imageError = "Only JPG, JPEG, and PNG files are allowed.";
                selectedImage = null;
                normalizedImageUrl = NormalizeImageUrl(productRequest?.ImageUrl);
                StateHasChanged();
                return;
            }

            if (selectedImage.Size > maxSize)
            {
                Logger.LogWarning("OnImageChange: File size exceeds 5MB: {Size}", selectedImage.Size);
                imageError = "File size must not exceed 5MB.";
                selectedImage = null;
                normalizedImageUrl = NormalizeImageUrl(productRequest?.ImageUrl);
                StateHasChanged();
                return;
            }

            using var stream = selectedImage.OpenReadStream(maxSize);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            var buffer = memoryStream.ToArray();
            normalizedImageUrl = $"data:{selectedImage.ContentType};base64,{Convert.ToBase64String(buffer)}";
            Logger.LogInformation("OnImageChange: Image preview generated successfully");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "OnImageChange: Error processing image");
            imageError = $"Error processing image: {ex.Message}";
            selectedImage = null;
            normalizedImageUrl = NormalizeImageUrl(productRequest?.ImageUrl);
        }
        StateHasChanged();
    }

    private string? NormalizeImageUrl(string? imageUrl)
    {
        try
        {
            if (string.IsNullOrEmpty(imageUrl) || imageUrl == "string")
            {
                Logger.LogDebug("NormalizeImageUrl: ImageUrl is null or invalid, using placeholder for RequestId {RequestId}", RequestId);
                return $"{BackendBaseUrl}/Assets/placeholder.jpg";
            }

            if (imageUrl.StartsWith("data:image"))
            {
                Logger.LogDebug("NormalizeImageUrl: Using base64 image for RequestId {RequestId}", RequestId);
                return imageUrl;
            }

            if (imageUrl.StartsWith("/"))
            {
                var normalizedUrl = $"{BackendBaseUrl}{imageUrl}";
                Logger.LogDebug("NormalizeImageUrl: Normalized {ImageUrl} to {NormalizedUrl} for RequestId {RequestId}", imageUrl, normalizedUrl);
                return normalizedUrl;
            }

            if (!Uri.IsWellFormedUriString(imageUrl, UriKind.Absolute))
            {
                Logger.LogDebug("NormalizeImageUrl: Invalid URL {ImageUrl} for RequestId {RequestId}, using placeholder", imageUrl);
                return $"{BackendBaseUrl}/Assets/placeholder.jpg";
            }

            Logger.LogDebug("NormalizeImageUrl: Using {ImageUrl} as is for RequestId {RequestId}", imageUrl);
            return imageUrl;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "NormalizeImageUrl: Error normalizing ImageUrl={ImageUrl}", imageUrl);
            return $"{BackendBaseUrl}/Assets/placeholder.jpg";
        }
    }

    private void HandleImageError()
    {
        Logger.LogWarning("HandleImageError: Image failed to load, URL={NormalizedUrl}, RequestId={RequestId}", normalizedImageUrl, RequestId);
        imageError = $"Image failed to load: {normalizedImageUrl}";
        normalizedImageUrl = $"{BackendBaseUrl}/Assets/placeholder.jpg";
        StateHasChanged();
    }

    private async Task FetchIngredients()
    {
        Logger.LogInformation("FetchIngredients: Initiated for RequestId: {RequestId}", RequestId);
        if (string.IsNullOrEmpty(productRequest?.ProductName))
        {
            notificationMessage = "Product name is required to fetch ingredients.";
            isSuccess = false;
            StateHasChanged();
            return;
        }

        if (string.IsNullOrEmpty(productRequest?.Country))
        {
            notificationMessage = "Country is required to fetch ingredients.";
            isSuccess = false;
            StateHasChanged();
            return;
        }

        if (isFetchingAI) return; // Prevent multiple clicks
        isFetchingAI = true;
        StateHasChanged();

        try
        {
            var request = new
            {
                productName = productRequest.ProductName,
                barcode = productRequest.Barcode,
                country = productRequest.Country
            };
            using var response = await HttpClient.PostAsJsonAsync($"{BackendBaseUrl}/api/Ingredient/get-ingredients", request);
            response.EnsureSuccessStatusCode();
            var result = await response.Content.ReadFromJsonAsync<ProductResponse>();

            if (result?.Ingredients?.Any() == true)
            {
                ingredients = result.Ingredients.Select(i => new IngredientDto
                {
                    Id = Guid.NewGuid(),
                    Name = i.Name ?? string.Empty,
                    ECode = i.ECode ?? string.Empty,
                    Description = i.Description ?? string.Empty,
                    Status = i.Status ?? "Unknown",
                    IsHalal = i.Status == "Halal" ? new List<string> { productRequest.Country ?? "None" } : new List<string> { "None" },
                    IsHaram = i.Status == "Haram" ? new List<string> { productRequest.Country ?? "None" } : new List<string> { "None" },
                    IsMushbooh = i.Status == "Mushbooh" ? new List<string> { productRequest.Country ?? "None" } : new List<string> { "None" },
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                }).ToList();
                ingredientsInput = string.Join("\n", ingredients.Select(i => i.Name));
                CalculateProductStatus();
                notificationMessage = "Ingredients fetched successfully.";
                isSuccess = true;
            }
            else
            {
                notificationMessage = "No ingredients found. Please enter ingredients manually.";
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error fetching ingredients.");
            notificationMessage = $"Error fetching ingredients: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isFetchingAI = false;
            StateHasChanged();
        }
    }

    private async Task EvaluateIngredients()
    {
        Logger.LogInformation("EvaluateIngredients: Initiated for RequestId: {RequestId}", RequestId);
        if (string.IsNullOrWhiteSpace(ingredientsInput))
        {
            productStatus = "Unknown";
            ingredients.Clear();
            notificationMessage = "No ingredients to evaluate.";
            isSuccess = false;
            StateHasChanged();
            return;
        }

        var ingredientList = ingredientsInput
            .Split('\n', StringSplitOptions.RemoveEmptyEntries)
            .Select(i => i.Trim())
            .Where(i => !string.IsNullOrEmpty(i))
            .ToList();

        if (!ingredientList.Any())
        {
            productStatus = "Unknown";
            ingredients.Clear();
            notificationMessage = "No valid ingredients to evaluate.";
            isSuccess = false;
            StateHasChanged();
            return;
        }

        if (isEvaluating) return; // Prevent multiple clicks
        isEvaluating = true;
        StateHasChanged();

        try
        {
            var request = new { Ingredients = ingredientList, Country = productRequest?.Country ?? string.Empty };
            Logger.LogInformation("EvaluateIngredients: Sending request: {Request}", System.Text.Json.JsonSerializer.Serialize(request));
            using var response = await HttpClient.PostAsJsonAsync($"{BackendBaseUrl}/api/Ingredient/evaluate-ingredients", request);
            response.EnsureSuccessStatusCode();
            var result = await response.Content.ReadFromJsonAsync<IngredientResponse>();
            Logger.LogInformation("EvaluateIngredients: Response received: {Response}", System.Text.Json.JsonSerializer.Serialize(result));

            if (result?.Ingredients?.Any() == true)
            {
                ingredients = result.Ingredients.Select(i => new IngredientDto
                {
                    Id = Guid.NewGuid(),
                    Name = i.Name ?? string.Empty,
                    ECode = i.ECode ?? "N/A",
                    Description = i.Description ?? "No description",
                    Status = i.Status ?? "Unknown",
                    IsHalal = i.IsHalal ?? new List<string> { "None" },
                    IsHaram = i.IsHaram ?? new List<string> { "None" },
                    IsMushbooh = i.IsMushbooh ?? new List<string> { "None" },
                    CreatedAt = i.CreatedAt != default ? i.CreatedAt : DateTime.UtcNow,
                    UpdatedAt = i.UpdatedAt != default ? i.UpdatedAt : DateTime.UtcNow
                }).ToList();
                ingredientsInput = string.Join("\n", ingredients.Select(i => i.Name));
                CalculateProductStatus();
                notificationMessage = "Ingredients evaluated successfully.";
                isSuccess = true;
            }
            else
            {
                productStatus = "Unknown";
                ingredients.Clear();
                notificationMessage = "Unable to evaluate ingredients.";
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error evaluating ingredients.");
            productStatus = "Unknown";
            ingredients.Clear();
            notificationMessage = $"Error evaluating ingredients: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isEvaluating = false;
            StateHasChanged();
        }
    }

    private void ChangeIngredientStatus(IngredientDto ingredient, string newStatus)
    {
        Logger.LogInformation("ChangeIngredientStatus: Status changed for ingredient {Name} to {Status}", ingredient.Name, newStatus);
        ingredient.Status = newStatus;
        ingredient.UpdatedAt = DateTime.UtcNow;

        // Update IsHalal, IsHaram, IsMushbooh based on new status
        var country = productRequest?.Country ?? "None";
        ingredient.IsHalal = newStatus == "Halal" ? new List<string> { country } : new List<string> { "None" };
        ingredient.IsHaram = newStatus == "Haram" ? new List<string> { country } : new List<string> { "None" };
        ingredient.IsMushbooh = newStatus == "Mushbooh" ? new List<string> { country } : new List<string> { "None" };

        CalculateProductStatus();
        notificationMessage = $"Status for '{ingredient.Name}' updated to {newStatus}.";
        isSuccess = true;
        StateHasChanged();
    }

    private void UpdateIngredientsFromInput()
    {
        var ingredientList = ingredientsInput
            .Split('\n', StringSplitOptions.RemoveEmptyEntries)
            .Select(i => i.Trim())
            .Where(i => !string.IsNullOrEmpty(i))
            .ToList();

        var updatedIngredients = new List<IngredientDto>();
        foreach (var name in ingredientList)
        {
            var existing = ingredients.FirstOrDefault(i => i.Name.Equals(name, StringComparison.OrdinalIgnoreCase));
            updatedIngredients.Add(existing ?? new IngredientDto
            {
                Id = Guid.NewGuid(),
                Name = name,
                ECode = "N/A",
                Description = "No description",
                Status = "Unknown",
                IsHalal = new List<string> { "None" },
                IsHaram = new List<string> { "None" },
                IsMushbooh = new List<string> { "None" },
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            });
        }
        ingredients = updatedIngredients;
        CalculateProductStatus();
    }

    private async Task OnIngredientsInputChange(ChangeEventArgs e)
    {
        ingredientsInput = e.Value?.ToString() ?? string.Empty;
        UpdateIngredientsFromInput();
    }

    private async Task UpdateIngredient(IngredientDto ingredient)
    {
        if (string.IsNullOrWhiteSpace(ingredient.Name))
        {
            notificationMessage = "Ingredient name cannot be empty.";
            isSuccess = false;
            StateHasChanged();
            return;
        }

        if (isEvaluating) return; // Prevent multiple clicks
        isEvaluating = true;
        StateHasChanged();

        try
        {
            var request = new { Ingredients = new[] { ingredient.Name }, Country = productRequest?.Country ?? string.Empty };
            using var response = await HttpClient.PostAsJsonAsync($"{BackendBaseUrl}/api/Ingredient/evaluate-ingredients", request);
            response.EnsureSuccessStatusCode();
            var result = await response.Content.ReadFromJsonAsync<IngredientResponse>();

            if (result?.Ingredients?.Any() == true)
            {
                var updatedIngredient = result.Ingredients.First();
                ingredient.ECode = updatedIngredient.ECode ?? "N/A";
                ingredient.Description = updatedIngredient.Description ?? "No description";
                ingredient.Status = updatedIngredient.Status ?? "Unknown";
                ingredient.IsHalal = updatedIngredient.IsHalal ?? new List<string> { "None" };
                ingredient.IsHaram = updatedIngredient.IsHaram ?? new List<string> { "None" };
                ingredient.IsMushbooh = updatedIngredient.IsMushbooh ?? new List<string> { "None" };
                ingredient.UpdatedAt = DateTime.UtcNow;
                CalculateProductStatus();
                notificationMessage = $"Ingredient '{ingredient.Name}' updated successfully.";
                isSuccess = true;
            }
            else
            {
                ingredient.Status = "Unknown";
                CalculateProductStatus();
                notificationMessage = $"Unable to evaluate ingredient '{ingredient.Name}'.";
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating ingredient: {IngredientName}", ingredient.Name);
            ingredient.Status = "Unknown";
            CalculateProductStatus();
            notificationMessage = $"Error updating ingredient '{ingredient.Name}': {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isEvaluating = false;
            StateHasChanged();
        }
        ingredientsInput = string.Join("\n", ingredients.Select(i => i.Name));
    }

    private void RemoveIngredient(IngredientDto ingredient)
    {
        ingredients.Remove(ingredient);
        ingredientsInput = string.Join("\n", ingredients.Select(i => i.Name));
        CalculateProductStatus();
        notificationMessage = "Ingredient removed successfully.";
        isSuccess = true;
        StateHasChanged();
    }

    private void CalculateProductStatus()
    {
        if (!ingredients.Any())
        {
            productStatus = "Unknown";
            return;
        }

        if (ingredients.Any(i => i.Status.Equals("Haram", StringComparison.OrdinalIgnoreCase)))
        {
            productStatus = "Haram";
        }
        else if (ingredients.Any(i => i.Status.Equals("Mushbooh", StringComparison.OrdinalIgnoreCase)))
        {
            productStatus = "Mushbooh";
        }
        else if (ingredients.All(i => i.Status.Equals("Halal", StringComparison.OrdinalIgnoreCase)))
        {
            productStatus = "Halal";
        }
        else
        {
            productStatus = "Unknown";
        }
    }

    private async Task ApproveProduct()
    {
        Logger.LogInformation("Approving product for RequestId: {RequestId}", RequestId);
        if (!ingredients.Any())
        {
            notificationMessage = "Please evaluate ingredients before approving.";
            isSuccess = false;
            StateHasChanged();
            return;
        }

        if (ingredients.Any(i => string.IsNullOrEmpty(i.Status) || i.Status == "Unknown"))
        {
            notificationMessage = "All ingredients must be evaluated (Halal, Haram, or Mushbooh) before approving.";
            isSuccess = false;
            StateHasChanged();
            return;
        }

        if (string.IsNullOrEmpty(productRequest?.ProductName) || string.IsNullOrEmpty(productRequest?.Country) ||
            string.IsNullOrEmpty(productRequest?.Category) || string.IsNullOrEmpty(productRequest?.Description))
        {
            notificationMessage = "All product fields (name, country, category, description) are required for approval.";
            isSuccess = false;
            StateHasChanged();
            return;
        }

        if (!await ConfirmAction("approve this product"))
        {
            return;
        }

        if (isSubmitting) return; // Prevent multiple clicks
        isSubmitting = true;
        StateHasChanged();

        try
        {
            // Prepare ingredients list for the API
            var ingredientsPayload = ingredients.Select(i => new
            {
                id = i.Id,
                name = i.Name ?? string.Empty,
                status = i.Status ?? "Unknown",
                eCode = i.ECode ?? "N/A",
                description = i.Description ?? string.Empty,
                isHalal = i.IsHalal?.ToArray() ?? new string[] { "None" },
                isHaram = i.IsHaram?.ToArray() ?? new string[] { "None" },
                isMushbooh = i.IsMushbooh?.ToArray() ?? new string[] { "None" },
                createdAt = i.CreatedAt.ToString("o"),
                updatedAt = i.UpdatedAt.ToString("o")
            }).ToList();

            // Log the payload for debugging
            var payloadJson = System.Text.Json.JsonSerializer.Serialize(ingredientsPayload, new JsonSerializerOptions { WriteIndented = true });
            Logger.LogInformation("ApproveProduct: Sending JSON payload for RequestId: {RequestId}: {Payload}", RequestId, payloadJson);

            using var response = await HttpClient.PostAsJsonAsync($"{BackendBaseUrl}/api/ProductChangeRequest/approve/{RequestId}", ingredientsPayload);
            var responseContent = await response.Content.ReadAsStringAsync();
            Logger.LogInformation("ApproveProduct: Response status: {StatusCode}, Content: {Content}", response.StatusCode, responseContent);

            if (response.IsSuccessStatusCode)
            {
                var result = await System.Text.Json.JsonSerializer.DeserializeAsync<ProcessRequestResponse>(
                    await response.Content.ReadAsStreamAsync(),
                    new JsonSerializerOptions { PropertyNameCaseInsensitive = true }
                );
                if (result?.IsSuccess == true)
                {
                    notificationMessage = "Product approved successfully.";
                    isSuccess = true;
                    await Task.Delay(2000);
                    Navigation.NavigateTo("/admin/product-requests");
                }
                else
                {
                    notificationMessage = $"Failed to approve product: {result?.Message ?? "Unknown error"}";
                    isSuccess = false;
                }
            }
            else
            {
                notificationMessage = $"Failed to approve product: {response.StatusCode} - {responseContent}";
                isSuccess = false;

                if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
                {
                    await ((CustomAuthStateProvider)AuthStateProvider).MarkUserAsLoggedOut();
                    Navigation.NavigateTo("/login");
                }
                else if (response.StatusCode == System.Net.HttpStatusCode.BadRequest)
                {
                    notificationMessage = $"Invalid data: {responseContent}";
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error approving product.");
            notificationMessage = $"Error approving product: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private async Task RejectProduct()
    {
        Logger.LogInformation("Rejecting product for RequestId: {RequestId}", RequestId);
        if (!await ConfirmAction("reject this product"))
        {
            return;
        }

        if (isSubmitting) return; // Prevent multiple clicks
        isSubmitting = true;
        StateHasChanged();

        try
        {
            var content = new { Reason = "Rejected by admin" };
            using var response = await HttpClient.PostAsJsonAsync($"{BackendBaseUrl}/api/ProductChangeRequest/reject/{RequestId}", content);
            var responseContent = await response.Content.ReadAsStringAsync();

            if (response.IsSuccessStatusCode)
            {
                var result = await System.Text.Json.JsonSerializer.DeserializeAsync<ProcessRequestResponse>(
                    await response.Content.ReadAsStreamAsync(),
                    new JsonSerializerOptions { PropertyNameCaseInsensitive = true }
                );
                if (result?.IsSuccess == true)
                {
                    notificationMessage = "Product rejected successfully.";
                    isSuccess = true;
                    await Task.Delay(2000);
                    Navigation.NavigateTo("/admin/product-requests");
                }
                else
                {
                    notificationMessage = $"Failed to reject product: {result?.Message}";
                    isSuccess = false;
                }
            }
            else
            {
                notificationMessage = $"Failed to reject product: {response.StatusCode} - {responseContent}";
                isSuccess = false;
                if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
                {
                    await ((CustomAuthStateProvider)AuthStateProvider).MarkUserAsLoggedOut();
                    Navigation.NavigateTo("/login");
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error rejecting product.");
            notificationMessage = $"Error rejecting product: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        Logger.LogInformation("Cancel: Navigating to /admin/product-requests");
        Navigation.NavigateTo("/admin/product-requests");
    }

    private ProductChangeRequestDto? DeserializeRequest(JsonElement element)
    {
        try
        {
            return new ProductChangeRequestDto
            {
                RequestId = element.GetProperty("requestId").GetGuid(),
                RequestType = element.GetProperty("requestType").GetString(),
                RequestStatus = element.GetProperty("requestStatus").GetString(),
                RequestedBy = element.GetProperty("requestedBy").GetString(),
                RequestDate = element.GetProperty("requestDate").GetDateTime(),
                ProductName = element.GetProperty("productName").GetString() ?? "N/A",
                ProductId = element.TryGetProperty("productId", out var productId) && productId.ValueKind != JsonValueKind.Null
                    ? productId.GetGuid()
                    : null,
                Barcode = element.GetProperty("barcode").GetString(),
                Country = element.GetProperty("country").GetString(),
                Category = element.TryGetProperty("category", out var category) ? category.GetString() : null,
                Description = element.TryGetProperty("description", out var description) ? description.GetString() : null,
                ImageUrl = element.TryGetProperty("imageUrl", out var imageUrl) ? imageUrl.GetString() : null,
                ActionDate = element.TryGetProperty("actionDate", out var actionDate) && actionDate.ValueKind != JsonValueKind.Null
                    ? actionDate.GetDateTime()
                    : null,
                Ingredients = element.TryGetProperty("ingredients", out var ingredients) && ingredients.ValueKind == JsonValueKind.Array
                    ? ingredients.EnumerateArray().Select(i => i.GetString()).ToList()
                    : new List<string>(),
                UseOnlyUserIngredients = element.TryGetProperty("useOnlyUserIngredients", out var useOnly) ? useOnly.GetBoolean() : false
            };
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deserializing request JSON: {Json}", element.GetRawText());
            return null;
        }
    }

    private string GetStatusColor(string status)
    {
        return status switch
        {
            "Halal" => "bg-green-600 text-white px-2 py-1 rounded",
            "Haram" => "bg-red-600 text-white px-2 py-1 rounded",
            "Mushbooh" => "bg-yellow-400 text-black px-2 py-1 rounded",
            _ => "bg-gray-100 text-gray-800 px-2 py-1 rounded"
        };
    }

    private async Task<bool> ConfirmAction(string action)
    {
        return await Task.FromResult(true);
    }

    private void ClearNotification()
    {
        notificationMessage = string.Empty;
        isSuccess = false;
        StateHasChanged();
    }

    private class BaseResponseModel
    {
        public bool Success { get; set; }
        public string? ErrorMessage { get; set; }
        public object? Data { get; set; }
    }

    private class ProductChangeRequestDto
    {
        [Required(ErrorMessage = "Product name is required")]
        public string? ProductName { get; set; }
        [Required(ErrorMessage = "Country is required")]
        public string? Country { get; set; }
        [Required(ErrorMessage = "Category is required")]
        public string? Category { get; set; }
        [Required(ErrorMessage = "Description is required")]
        public string? Description { get; set; }
        public Guid RequestId { get; set; }
        public string? RequestType { get; set; }
        public string? RequestStatus { get; set; }
        public string? RequestedBy { get; set; }
        public DateTime RequestDate { get; set; }
        public DateTime? ActionDate { get; set; }
        public Guid? ProductId { get; set; }
        public string? Barcode { get; set; }
        public string? ImageUrl { get; set; }
        public List<string> Ingredients { get; set; } = new();
        public bool UseOnlyUserIngredients { get; set; }
    }

    private class IngredientDto
    {
        public Guid Id { get; set; }
        public string? Name { get; set; }
        public string? ECode { get; set; }
        public string? Description { get; set; }
        public string? Status { get; set; }
        public List<string>? IsHalal { get; set; } = new();
        public List<string>? IsHaram { get; set; } = new();
        public List<string>? IsMushbooh { get; set; } = new();
        public DateTime CreatedAt { get; set; }
        public DateTime UpdatedAt { get; set; }
    }

    private class ProcessRequestResponse
    {
        public Guid RequestId { get; set; }
        public bool IsSuccess { get; set; }
        public string Message { get; set; } = string.Empty;
        public ProductChangeRequestDto? Request { get; set; }
        public object? Product { get; set; }
        public List<IngredientDto> Ingredients { get; set; } = new();
    }

    private class LoginResponseModel
    {
        public string Token { get; set; } = string.Empty;
    }

    private class ProductResponse
    {
        public List<IngredientDto> Ingredients { get; set; } = new();
        public string Country { get; set; } = string.Empty;
    }

    private class IngredientResponse
    {
        public List<IngredientDto> Ingredients { get; set; } = new();
    }
}
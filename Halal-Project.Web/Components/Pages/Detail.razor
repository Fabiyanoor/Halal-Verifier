@page "/product/{ProductId:guid}"
@rendermode InteractiveServer
@inject HttpClient HttpClient
@inject NavigationManager Navigation
@using System.Text.Json

<div class="flex min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
    <!-- Main Content -->
    <div class="flex-1 overflow-y-auto p-6 md:p-10">
        @if (!string.IsNullOrEmpty(notificationMessage))
        {
            <div class="mb-6 rounded-lg p-4 shadow-lg @(isSuccess ? "bg-green-50 text-green-800 border border-green-200" : "bg-red-50 text-red-800 border border-red-200") transition-all duration-300">
                @notificationMessage
                <button @onclick="ClearNotification" class="ml-4 text-sm font-semibold hover:underline focus:outline-none">Close</button>
            </div>
        }

        <div class="rounded-2xl bg-white p-6 md:p-8 shadow-xl border border-gray-100">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-blue-900 tracking-tight">Product Details</h2>
                <button @onclick="NavigateBack" class="rounded-lg bg-blue-600 text-white px-5 py-2.5 hover:bg-blue-700 transition-colors duration-200 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    Back to Products
                </button>
            </div>

            @if (isLoading)
            {
                <div class="flex justify-center items-center h-64">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-600"></div>
                </div>
            }
            else if (product != null)
            {
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Left Column: Image -->
                    <div class="lg:col-span-1">
                        <div class="relative rounded-xl overflow-hidden shadow-md bg-gray-100 flex items-center justify-center">
                            @if (!string.IsNullOrEmpty(product.ImageUrl) && product.ImageUrl != "string")
                            {
                                <img src="@NormalizeImageUrl(product.ImageUrl)" alt="@product.ProductName" class="h-56 w-56 object-contain" loading="lazy" @onerror="HandleImageError" />
                            }
                            else
                            {
                                <div class="h-56 w-56 flex items-center justify-center bg-gray-200">
                                    <svg class="h-10 w-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                            }
                        </div>
                    </div>
                    <!-- Right Column: Product Info and Ingredients -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Product Info -->
                        <div class="bg-gray-50 p-6 rounded-xl shadow-sm">
                            <h3 class="text-xl font-semibold text-blue-900 mb-4">Product Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm font-medium text-blue-900">Product Name</label>
                                    <p class="text-lg font-semibold text-gray-900">@product.ProductName</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-blue-900">Category</label>
                                    <p class="text-gray-700">@product.Category</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-blue-900">Country</label>
                                    <p class="text-gray-700">@product.Country</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-blue-900">Barcode</label>
                                    <p class="text-gray-700">@(string.IsNullOrEmpty(product.Barcode) ? "N/A" : product.Barcode)</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-blue-900">Status</label>
                                    <span class="@GetStatusColor(product.Status) text-sm font-medium px-3 py-1 rounded-full">
                                        @product.Status
                                    </span>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="text-sm font-medium text-blue-900">Description</label>
                                <p class="text-gray-700 mt-1 leading-relaxed">@product.Description</p>
                            </div>
                        </div>

                        <!-- Ingredients -->
                        <div class="bg-gray-50 p-6 rounded-xl shadow-sm">
                            <h3 class="text-xl font-semibold text-blue-900 mb-4">Ingredients</h3>
                            @if (product.Ingredients.Any())
                            {
                                <div class="flex flex-wrap gap-2">
                                    @foreach (var ingredient in product.Ingredients)
                                    {
                                        <span class="inline-flex items-center px-3 py-1 rounded-full bg-white shadow-sm text-sm font-medium text-gray-900">
                                            @ingredient.Name
                                            <span class="@(ingredient.Status == "Halal" ? "ml-2 text-green-600 bg-green-100" : ingredient.Status == "Haram" ? "ml-2 text-red-600 bg-red-100" : "ml-2 text-yellow-600 bg-yellow-100") font-semibold px-2 py-0.5 rounded-full text-xs">
                                                @ingredient.Status
                                            </span>
                                        </span>
                                    }
                                </div>
                            }
                            else
                            {
                                <p class="text-gray-500 italic">No ingredients listed for this product.</p>
                            }
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="text-center py-16 bg-gray-50 rounded-xl">
                    <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h3 class="mt-4 text-lg font-medium text-gray-900">Product Not Found</h3>
                    <p class="mt-2 text-sm text-gray-500">The requested product could not be found.</p>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public Guid ProductId { get; set; }

    private ProductDto? product;
    private bool isLoading = true;
    private string notificationMessage = string.Empty;
    private bool isSuccess = false;
    private const string BackendBaseUrl = "https://localhost:7507";

    protected override async Task OnInitializedAsync()
    {
        await LoadProductDetails();
        isLoading = false;
        StateHasChanged();
    }

    private async Task LoadProductDetails()
    {
        try
        {
            Console.WriteLine($"LoadProductDetails: Fetching product {ProductId} from {BackendBaseUrl}/api/Product/{ProductId}");
            var response = await HttpClient.GetFromJsonAsync<BaseResponseModel>($"{BackendBaseUrl}/api/Product/{ProductId}", new JsonSerializerOptions
            {
                PropertyNamingPolicy = JsonNamingPolicy.CamelCase
            });

            if (response?.Success == true && response.Data != null)
            {
                var data = (JsonElement)response.Data;
                product = new ProductDto
                {
                    Id = data.GetProperty("id").GetGuid(),
                    ProductName = data.GetProperty("productName").GetString() ?? "Unknown",
                    Status = data.GetProperty("status").GetString() ?? "Unknown",
                    Category = data.GetProperty("category").GetString() ?? "Unknown",
                    Country = data.GetProperty("country").GetString() ?? "Unknown",
                    Description = data.GetProperty("description").GetString() ?? "No description available",
                    Barcode = data.TryGetProperty("barcode", out var barcode) ? barcode.GetString() : null,
                    ImageUrl = data.TryGetProperty("imageUrl", out var imageUrl) ? imageUrl.GetString() : null,
                    Ingredients = data.TryGetProperty("productIngredients", out var productIngredients)
                        ? productIngredients.EnumerateArray()
                            .Select(pi => new IngredientDto
                            {
                                Name = pi.TryGetProperty("ingredient", out var ingredient) && ingredient.TryGetProperty("name", out var name) ? name.GetString() ?? "Unknown" : "Unknown",
                                Status = ingredient.TryGetProperty("status", out var status) ? status.GetString() ?? "Unknown" : "Unknown"
                            })
                            .ToList()
                        : new List<IngredientDto>()
                };
                Console.WriteLine($"LoadProductDetails: Loaded product {product.ProductName}, ImageUrl: {product.ImageUrl ?? "None"}, Ingredients: {product.Ingredients.Count}");
            }
            else
            {
                Console.WriteLine("LoadProductDetails: API response was unsuccessful or no data");
                notificationMessage = "Failed to load product details.";
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"LoadProductDetails: Error: {ex.Message}, StackTrace: {ex.StackTrace}");
            notificationMessage = $"Error loading product details: {ex.Message}";
            isSuccess = false;
        }
    }

    private string NormalizeImageUrl(string? imageUrl)
    {
        if (string.IsNullOrEmpty(imageUrl) || imageUrl == "string")
        {
            Console.WriteLine($"NormalizeImageUrl: Invalid or empty ImageUrl, using placeholder for product {ProductId}");
            return $"{BackendBaseUrl}/Assets/placeholder.jpg";
        }

        if (imageUrl.StartsWith("/"))
        {
            var normalizedUrl = $"{BackendBaseUrl}{imageUrl}";
            Console.WriteLine($"NormalizeImageUrl: Normalized {imageUrl} to {normalizedUrl} for product {ProductId}");
            return normalizedUrl;
        }

        if (!Uri.IsWellFormedUriString(imageUrl, UriKind.Absolute))
        {
            Console.WriteLine($"NormalizeImageUrl: Invalid URL {imageUrl} for product {ProductId}, using placeholder");
            return $"{BackendBaseUrl}/Assets/placeholder.jpg";
        }

        Console.WriteLine($"NormalizeImageUrl: Using {imageUrl} as is for product {ProductId}");
        return imageUrl;
    }

    private void HandleImageError(Microsoft.AspNetCore.Components.Web.ErrorEventArgs e)
    {
        Console.WriteLine($"HandleImageError: Image failed to load for product {ProductId}, Error: {e.Message}");
        notificationMessage = "Failed to load product image.";
        isSuccess = false;
        StateHasChanged();
    }

    private string GetStatusColor(string status)
    {
        return status switch
        {
            "Halal" => "bg-green-100 text-green-800",
            "Haram" => "bg-red-100 text-red-800",
            "Mushbooh" => "bg-yellow-100 text-yellow-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }

    private void NavigateBack()
    {
        Console.WriteLine("NavigateBack: Navigating to previous page");
        Navigation.NavigateTo("javascript:history.back()");
    }
    private void ClearNotification()
    {
        notificationMessage = string.Empty;
        isSuccess = false;
        StateHasChanged();
    }

    private class BaseResponseModel
    {
        public bool Success { get; init; }
        public string? ErrorMessage { get; init; }
        public object? Data { get; init; }
    }

    private class ProductDto
    {
        public Guid Id { get; init; }
        public string ProductName { get; init; } = string.Empty;
        public string Status { get; init; } = string.Empty;
        public string Category { get; init; } = string.Empty;
        public string Country { get; init; } = string.Empty;
        public string Description { get; init; } = string.Empty;
        public string? Barcode { get; init; }
        public string? ImageUrl { get; init; }
        public List<IngredientDto> Ingredients { get; init; } = new();
    }

    private class IngredientDto
    {
        public string Name { get; init; } = string.Empty;
        public string Status { get; init; } = string.Empty;
    }
}
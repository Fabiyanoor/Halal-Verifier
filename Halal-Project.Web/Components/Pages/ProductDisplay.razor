@page "/products"
@using System.Text.Json
@rendermode InteractiveServer
@inject HttpClient HttpClient
@inject NavigationManager Navigation
@implements IDisposable

<!-- Include Navbar Component -->
<Navbar />

<div class="min-h-screen bg-gray-50 pt-20">
    <!-- Search and Filter Bar -->
    <div class="w-full bg-white shadow-md border-b border-gray-100">
        <div class="w-full px-2 sm:px-4 lg:px-6 py-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- Search Input -->
                <div class="md:col-span-2">
                    <div class="relative">
                        <input type="text"
                               @bind="searchQuery"
                               @oninput="HandleSearchInput"
                               placeholder="Search products by name..."
                               class="w-full pl-12 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition-all duration-200 text-sm font-medium text-blue-900 placeholder-gray-700" />
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Status Filter -->
                <div>
                    <div class="relative">
                        <select @bind="selectedStatus" @bind:after="HandleStatusChange" class="w-full pl-10 pr-8 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition-all duration-300 text-sm font-medium text-blue-900 appearance-none">
                            <option value="">All Statuses</option>
                            <option value="Halal">Halal</option>
                            <option value="Haram">Haram</option>
                            <option value="Mushbooh">Mushbooh</option>
                        </select>
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Category Filter -->
                <div>
                    <div class="relative">
                        <select @bind="selectedCategory" @bind:after="HandleCategoryChange" class="w-full pl-10 pr-8 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition-all duration-300 text-sm font-medium text-blue-900 appearance-none">
                            <option value="">All Categories</option>
                            @foreach (var category in availableCategories)
                            {
                                <option value="@category">@category</option>
                            }
                        </select>
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Message -->
    <!-- Error Message -->
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-6 py-4">
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                <span class="block sm:inline">@errorMessage</span>
                <button @onclick="ClearErrorMessage" class="ml-4 text-red-700 font-bold">Dismiss</button>
            </div>
        </div>
    }

    <!-- Product Grid -->
    <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-6 py-8">
        @if (isLoading)
        {
            <div class="flex justify-center items-center h-64">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-600"></div>
            </div>
        }
        else if (filteredProducts.Any())
        {
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                @foreach (var product in filteredProducts)
                {
                    <div class="bg-white rounded-2xl shadow-md overflow-hidden hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1 border border-gray-100 flex flex-col h-[400px]">
                        <!-- Product Image -->
                        <div class="h-48 bg-gray-100 p-2 flex-shrink-0">
                            @if (!string.IsNullOrEmpty(product.ImageUrl) && product.ImageUrl != "string")
                            {
                                <img src="@NormalizeImageUrl(product.ImageUrl)"
                                     alt="@product.ProductName"
                                     class="w-full h-full object-cover rounded-lg transition-all duration-300 hover:scale-105"
                                     loading="lazy"
                                     @onerror="HandleImageError" />
                            }
                            else
                            {
                                <div class="w-full h-full flex items-center justify-center bg-gray-100 rounded-lg">
                                    <svg class="h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                            }
                        </div>

                        <!-- Product Info -->
                        <div class="p-5 flex flex-col flex-grow">
                            <h3 class="font-semibold text-gray-900 text-base h-12 line-clamp-2 mb-3 tracking-tight">@product.ProductName</h3>

                            <!-- Status Badge -->
                            <div class="mb-4">
                                <span class="@GetStatusColor(product.Status) text-xs font-medium px-3 py-1.5 rounded-full">
                                    @product.Status
                                </span>
                            </div>

                            <!-- Spacer to push button to bottom -->
                            <div class="flex-grow"></div>

                            <!-- View Button -->
                            <button @onclick="() => ViewProductDetails(product.Id)"
                                    class="w-full text-sm px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-all duration-200 font-medium shadow-sm hover:shadow-md">
                                View Details
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="text-center py-16 bg-white rounded-2xl shadow-md border border-gray-100">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h3 class="mt-3 text-lg font-semibold text-gray-900 tracking-tight">No Products Found</h3>
                <p class="mt-2 text-sm text-gray-500">Try adjusting your search or filter criteria</p>
            </div>
        }
    </div>
</div>

<style>
    /* Custom styles for enhanced UI */
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
    }

    select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1.25rem;
    }
</style>

@code {
    private List<ProductDto> filteredProducts = new();
    private List<ProductDto> cachedProducts = new();
    private List<string> availableCategories = new();
    private bool isLoading = true;
    private bool isFetching = false;
    private string searchQuery = "";
    private string selectedStatus = "";
    private string selectedCategory = "";
    private string lastFilterHash = "";
    private string errorMessage = "";
    private CancellationTokenSource pollingCts = new();
    private CancellationTokenSource debounceCts = new();
    private const string BackendBaseUrl = "https://localhost:7507"; // Adjust if backend is on a different port

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Console.WriteLine("OnInitializedAsync: Loading categories and products");
            await LoadCategories();
            await LoadProducts(false);
            _ = StartPolling();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"OnInitializedAsync: Error: {ex.Message}, StackTrace: {ex.StackTrace}");
            errorMessage = "Failed to load products. Please try again.";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadCategories()
    {
        try
        {
            Console.WriteLine("LoadCategories: Fetching categories from API");
            var response = await HttpClient.GetFromJsonAsync<BaseResponseModel>($"{BackendBaseUrl}/api/Product/categories");
            if (response?.Success == true && response.Data != null)
            {
                availableCategories = ((JsonElement)response.Data)
                    .EnumerateArray()
                    .Select(e => e.GetString())
                    .Where(c => !string.IsNullOrEmpty(c))
                    .OrderBy(c => c)
                    .ToList();
                Console.WriteLine($"LoadCategories: Loaded {availableCategories.Count} categories");
            }
            else
            {
                Console.WriteLine("LoadCategories: API response was unsuccessful or empty");
                errorMessage = "Failed to load categories.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"LoadCategories: Error: {ex.Message}, StackTrace: {ex.StackTrace}");
            errorMessage = "Error loading categories. Please check your connection.";
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task LoadProducts(bool forceRefresh)
    {
        var filterHash = $"{searchQuery}|{selectedCategory}|{selectedStatus}";
        if (!forceRefresh && filterHash == lastFilterHash && cachedProducts.Any())
        {
            Console.WriteLine("LoadProducts: Using cached products with local filtering");
            filteredProducts = FilterProductsLocally(cachedProducts);
            StateHasChanged();
            return;
        }

        if (isFetching)
        {
            Console.WriteLine("LoadProducts: Already fetching, skipping");
            return;
        }

        isFetching = true;
        try
        {
            var url = $"{BackendBaseUrl}/api/Product";
            Console.WriteLine($"LoadProducts: Fetching from {url}");

            isLoading = true;
            errorMessage = "";
            StateHasChanged();

            var response = await HttpClient.GetFromJsonAsync<BaseResponseModel>(url, new JsonSerializerOptions
            {
                PropertyNamingPolicy = JsonNamingPolicy.CamelCase
            });

            if (response == null)
            {
                Console.WriteLine("LoadProducts: Response is null");
                errorMessage = "No response from server. Please check your connection.";
                return;
            }

            if (response.Success && response.Data != null)
            {
                cachedProducts = ((JsonElement)response.Data).EnumerateArray()
                    .Select(p =>
                    {
                        var product = new ProductDto
                        {
                            Id = p.GetProperty("id").GetGuid(),
                            ProductName = p.GetProperty("productName").GetString() ?? "Unknown",
                            Country = p.GetProperty("country").GetString() ?? "Unknown",
                            Status = p.GetProperty("status").GetString() ?? "Unknown",
                            ImageUrl = p.TryGetProperty("imageUrl", out var imageUrl) ? imageUrl.GetString() : null,
                            Category = p.GetProperty("category").GetString() ?? "Unknown"
                        };
                        Console.WriteLine($"LoadProducts: Product {product.ProductName}, ImageUrl: {product.ImageUrl ?? "None"}");
                        return product;
                    })
                    .ToList();

                filteredProducts = FilterProductsLocally(cachedProducts);
                lastFilterHash = filterHash;
                Console.WriteLine($"LoadProducts: Loaded {cachedProducts.Count} products, filtered to {filteredProducts.Count}");
            }
            else
            {
                Console.WriteLine("LoadProducts: API response was unsuccessful or empty");
                errorMessage = response.ErrorMessage ?? "Failed to load products.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"LoadProducts: Error: {ex.Message}, StackTrace: {ex.StackTrace}");
            errorMessage = $"Error loading products: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            isFetching = false;
            StateHasChanged();
        }
    }

    private List<ProductDto> FilterProductsLocally(List<ProductDto> products)
    {
        return products
            .Where(p => string.IsNullOrEmpty(searchQuery) ||
                        (p.ProductName?.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ?? false))
            .Where(p => string.IsNullOrEmpty(selectedStatus) ||
                        (p.Status?.Equals(selectedStatus, StringComparison.OrdinalIgnoreCase) ?? false))
            .Where(p => string.IsNullOrEmpty(selectedCategory) ||
                        (p.Category?.Equals(selectedCategory, StringComparison.OrdinalIgnoreCase) ?? false))
            .ToList();
    }

    private async Task StartPolling()
    {
        try
        {
            Console.WriteLine("StartPolling: Starting product polling");
            while (!pollingCts.Token.IsCancellationRequested)
            {
                await LoadProducts(true);
                await Task.Delay(10000, pollingCts.Token);
            }
        }
        catch (TaskCanceledException)
        {
            Console.WriteLine("StartPolling: Polling cancelled");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"StartPolling: Error: {ex.Message}, StackTrace: {ex.StackTrace}");
            errorMessage = "Polling failed. Displaying cached products if available.";
            StateHasChanged();
        }
    }

    private async Task HandleSearchInput(ChangeEventArgs e)
    {
        searchQuery = e.Value?.ToString() ?? "";
        Console.WriteLine($"HandleSearchInput: Search query updated to '{searchQuery}'");
        debounceCts.Cancel();
        debounceCts = new CancellationTokenSource();

        try
        {
            await Task.Delay(500, debounceCts.Token);
            await LoadProducts(false);
        }
        catch (TaskCanceledException)
        {
            Console.WriteLine("HandleSearchInput: Debounce cancelled");
        }
    }

    private async Task HandleStatusChange()
    {
        Console.WriteLine($"HandleStatusChange: Status updated to '{selectedStatus}'");
        await LoadProducts(false);
    }

    private async Task HandleCategoryChange()
    {
        Console.WriteLine($"HandleCategoryChange: Category updated to '{selectedCategory}'");
        await LoadProducts(false);
    }

    private string NormalizeImageUrl(string imageUrl)
    {
        if (string.IsNullOrEmpty(imageUrl) || imageUrl == "string")
        {
            Console.WriteLine("NormalizeImageUrl: Invalid or empty ImageUrl, using placeholder");
            return $"{BackendBaseUrl}/Assets/placeholder.png";
        }

        if (imageUrl.StartsWith("/"))
        {
            var normalizedUrl = $"{BackendBaseUrl}{imageUrl}";
            Console.WriteLine($"NormalizeImageUrl: Normalized {imageUrl} to {normalizedUrl}");
            return normalizedUrl;
        }

        Console.WriteLine($"NormalizeImageUrl: Using {imageUrl} as is");
        return imageUrl;
    }

    private void HandleImageError(Microsoft.AspNetCore.Components.Web.ErrorEventArgs e)
    {
        Console.WriteLine($"HandleImageError: Image failed to load, Error: {e.Message}");
    }

    private void ClearErrorMessage()
    {
        errorMessage = "";
        StateHasChanged();
    }

    public void Dispose()
    {
        try
        {
            Console.WriteLine("Dispose: Cleaning up resources");
            pollingCts.Cancel();
            pollingCts.Dispose();
            debounceCts.Cancel();
            debounceCts.Dispose();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Dispose: Error: {ex.Message}, StackTrace: {ex.StackTrace}");
        }
    }

    private string GetStatusColor(string status)
    {
        return status switch
        {
            "Halal" => "bg-green-100 text-green-800",
            "Haram" => "bg-red-100 text-red-800",
            "Mushbooh" => "bg-yellow-100 text-yellow-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }

    private void ViewProductDetails(Guid productId)
    {
        try
        {
            Console.WriteLine($"ViewProductDetails: Navigating to /product/{productId}");
            Navigation.NavigateTo($"/product/{productId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ViewProductDetails: Error: {ex.Message}, StackTrace: {ex.StackTrace}");
            errorMessage = "Failed to navigate to product details.";
            StateHasChanged();
        }
    }

    // Model classes
    private class BaseResponseModel
    {
        public bool Success { get; set; }
        public string ErrorMessage { get; set; } = string.Empty;
        public object Data { get; set; } = null!;
    }

    private class ProductDto
    {
        public Guid Id { get; set; }
        public string ProductName { get; set; } = string.Empty;
        public string Country { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public string? ImageUrl { get; set; }
        public string Category { get; set; } = string.Empty;
    }
}